<style>
  .variant-matrix {
    width: 100%;
    border-collapse: collapse;
    font-family: sans-serif;
    text-align: center;
    margin-top: 2rem;
    table-layout: unset !important;
  }

  .variant-matrix th,
  .variant-matrix td {
    border: 1px solid #ddd;
    padding: 10px;
  }

  .variant-matrix thead th {
    background-color: #f5f5f5;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .variant-matrix td img {
    border-radius: 6px;
    margin-bottom: 0.3rem;
  }

  .variant-matrix input[type='number'] {
    width: 50px;
    padding: 4px;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
  }

  .variant-matrix td {
    font-size: 0.9rem;
  }

  .variant-matrix td:last-child,
  .variant-matrix th:last-child {
    font-weight: bold;
    font-size: 1.1rem;
    color: #555;
  }

  .variant-matrix td:nth-last-child(2),
  .variant-matrix th:nth-last-child(2) {
    white-space: nowrap;
  }
  .who-qof-wrapper .quantity button {
    width: 20px;
  }
  .variant-matrix.p-hidden {
    display: none;
  }
</style>

<table
  data-area="variant_tr"
  class="
    small-hide medium-hide
    variant-matrix  variants-product-id{{ product.id }}
     {% if product.variants.size > 1 %}p-hidden{% endif %}
    {% if product.variants.size > 1 %}row-variant{% endif %}
      row-variant-id{{ variant.id }} v-hidden
  "
>
  <thead>
    <tr>
      <th></th>
      <th>Variants</th>
      {% comment %}
        {% assign sizes = '' %}
        {% for variant in product.variants %}
          {% unless sizes contains variant.options[1] %}
            {% assign sizes = sizes | append: variant.options[1] | append: ',' %}
          {% endunless %}
        {% endfor %}
        {% assign size_array = sizes | split: ',' %}
      {% endcomment %}

      {% assign sizes = '' %}
      {% if product.options.size > 1 %}
        {% for variant in product.variants %}
          {% unless sizes contains variant.options[1] %}
            {% assign sizes = sizes | append: variant.options[1] | append: ',' %}
          {% endunless %}
        {% endfor %}
      {% elsif product.options.size == 1 %}
        {% for variant in product.variants %}
          {% unless sizes contains variant.options[0] %}
            {% assign sizes = sizes | append: variant.options[0] | append: ',' %}
          {% endunless %}
        {% endfor %}
      {% else %}
        {% assign sizes = 'Default' %}
      {% endif %}

      {% assign size_array = sizes | split: ',' %}

      {% for size in size_array %}
        {% if size != '' %}
          <th>{{ size }}</th>
        {% endif %}
      {% endfor %}
      <th>Prezzo</th>
      <th>Totale</th>
    </tr>
  </thead>
  <tbody>
    {% comment %}
      {% assign colors = '' %}
      {% for variant in product.variants %}
        {% unless colors contains variant.options[0] %}
          {% assign colors = colors | append: variant.options[0] | append: ',' %}
        {% endunless %}
      {% endfor %}
      {% assign color_array = colors | split: ',' %}
    {% endcomment %}
    {% assign colors = '' %}

    {% if product.options.size > 1 %}
      {% for variant in product.variants %}
        {% unless colors contains variant.options[0] %}
          {% assign colors = colors | append: variant.options[0] | append: ',' %}
        {% endunless %}
      {% endfor %}
    {% elsif product.options.size == 1 %}
      {% for variant in product.variants %}
        {% unless colors contains variant.options[0] %}
          {% assign colors = colors | append: variant.options[0] | append: ',' %}
        {% endunless %}
      {% endfor %}
    {% else %}
      {% assign colors = 'Default' %}
    {% endif %}

    {% assign color_array = colors | split: ',' %}

    {% for color in color_array %}
      {% if color != '' %}
        <tr>
          <td>
            <img
              src="{{ product.featured_image | img_url: '100x100' }}"
              alt="{{ color }}"
              style="max-width:50px;"
            >
          </td>
          <td>
            {{ color }}
          </td>

          {% for size in size_array %}
            {% if size != '' %}
              {% comment %}
                {% assign match_variant = false %}
                {% for variant in product.variants %}
                  {% if variant.options[0] == color and variant.options[1] == size %}
                    {% assign match_variant = variant %}
                  {% endif %}
                {% endfor %}
              {% endcomment %}
              {% assign match_variant = false %}

              {% for variant in product.variants %}
                {% if product.options.size == 2 %}
                  {% if variant.options[0] == color and variant.options[1] == size %}
                    {% assign match_variant = variant %}
                  {% endif %}
                {% elsif product.options.size == 1 %}
                  {% if variant.options[0] == color or variant.options[0] == size %}
                    {% assign match_variant = variant %}
                  {% endif %}
                {% elsif product.options.size == 0 %}
                  {% assign match_variant = variant %}
                {% endif %}
              {% endfor %}

              <td style="text-align: center;">
                {% assign disabled = '' %}
                {% assign max = '' %}
                {% unless match_variant.inventory_management == blank or match_variant.inventory_policy == 'continue' %}
                  {% assign max = match_variant.inventory_quantity %}
                  {% for item in cart.items %}
                    {% if item.id == match_variant.id %}
                      {% assign max = max | minus: item.quantity %}
                    {% endif %}
                  {% endfor %}
                {% endunless %}
                {%- unless match_variant.inventory_management == blank
                  or match_variant.inventory_policy == 'continue'
                -%}
                  {% if max < 1 %}{% assign disabled = 'disabled' %}{% endif %}
                {%- endunless -%}
                <quantity-input class="quantity {{ disabled }}">
                  <button class="quantity__button no-js-hidden" name="minus" type="button">
                    <span class="visually-hidden">
                      {{- 'products.product.quantity.decrease' | t: product: product.title | escape -}}
                    </span>
                    -
                  </button>

                  <input
                    class="quantity__input variant-qty"
                    type="number"
                    value="0"
                    min="0"
                    aria-label="{{ 'products.product.quantity.input_label' | t: product: product.title | escape }}"
                    data-id="{{ match_variant.id }}"
                    onfocus="this.select()"
                    {% if max %}
                      max="{{ max }}"
                    {% endif %}
                    {{ disabled }}
                  >
                  <button class="quantity__button no-js-hidden" name="plus" type="button">
                    <span class="visually-hidden">
                      {{- 'products.product.quantity.increase' | t: product: product.title | escape -}}
                    </span>
                    +
                  </button>
                </quantity-input>
              </td>
            {% endif %}
          {% endfor %}

          {% assign color_variant = product.variants | where: 'option1', color | first %}
          <td>{{ color_variant.price | money }}</td>
          <td class="variant-total">0</td>
          <!-- Optional JS for total qty per row -->
        </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const rows = document.querySelectorAll('.variant-matrix tbody tr');

    rows.forEach((row) => {
      const inputs = row.querySelectorAll('input.variant-qty');

      inputs.forEach((input) => {
        input.addEventListener('input', () => updateRowTotal(row));
      });

      // Optional: Also handle +/- buttons if they are used
      const buttons = row.querySelectorAll('.quantity__button');
      buttons.forEach((button) => {
        button.addEventListener('click', () => {
          const input = button.parentElement.querySelector('.variant-qty');
          const step = button.name === 'plus' ? 1 : -1;
          input.value = Math.max(0, parseInt(input.value || 0) + step);
          updateRowTotal(row);
        });
      });
    });

    function updateRowTotal(row) {
      let total = 0;
      const inputs = row.querySelectorAll('input.variant-qty');
      inputs.forEach((input) => {
        total += parseInt(input.value) || 0;
      });
      const totalCell = row.querySelector('.variant-total');
      if (totalCell) totalCell.textContent = total;
    }
  });
</script>

{% comment %} old code  {% endcomment %}
{% comment %}
  {% for variant in product.variants %}
    {% unless variant.title contains '% Off' %}
      {% assign vtitle = variant.title | append: product.title | downcase %}
      {% unless vtitle contains 'luer slip syringe' or vtitle contains 'luer lock syringe' %}
        {% if variant.available %}
          {% assign featured_image = variant.featured_image | default: product.featured_image %}

          <tr
            data-area="variant_tr"
            class="variants-product-id{{ product.id }} {% if product.variants.size > 1 %}p-hidden{% endif %} {% if product.variants.size > 1 %}row-variant{% endif %} row-variant-id{{ variant.id }} v-hidden"
          >
            <td class="img">
              <a href="{{ variant.url }}">
                <img
                  src="{{ featured_image | img_url: 'small' }}"
                  alt="{{ featured_image.alt | escape }}"
                  height=""
                  width=""
                >
              </a>
              {% if product_featured_image != featured_image %}
              {% endif %}
            </td>

            <td style="white-space: normal;text-align:left;">
              <a href="{{ product.url | collection }}">
                {% if product.variants.size == 1 %}
                  {{ product.title -}}
                  <br>
                {% endif %}
                {% unless variant.title contains 'Default' %}{{ variant.title }}{% endunless %}
              </a>
              <br>
              {% for tag in product.tags %}
                {% if tag contains 'Minimum' or tag contains 'units' %}
                  <b>{{ tag }}</b>
                {% endif %}
              {% endfor %}
            </td>

            <td class="qo-sku">
              {{ variant.sku }}
            </td>

            <td style="text-align:right;">
              {% if shop.metafields.sawholesale.base_price == blank %}
                {% assign base_price = 'compare_at_price' %}
              {% else %}
                {% assign base_price = shop.metafields.sawholesale.base_price %}
              {% endif %}

              {% assign saw_discount = 0 -%}
              {%- assign saw_has_discount = false %}

              {% if customer.tags != blank %}
                {% for mf in product.metafields.sawholesale %}
                  {% capture product_customer_tag %}{{ mf | first | replace: 'discount_', '' }}{% endcapture %}
                  {% if customer.tags contains product_customer_tag %}
                    {% assign saw_has_discount = true %}
                    {% assign discount_key = product_customer_tag | prepend: 'discount_' %}
                    {% assign price_key = product_customer_tag | prepend: 'price_' %}
                    {% assign saw_discount = product.metafields.sawholesale[discount_key]
                      | divided_by: 100.0
                    %}
                  {% endif %}
                {% endfor %}
              {% endif %}

              {% assign saw_discount = 1 | minus: saw_discount %}

              {% if base_price == 'price'
                or variant.compare_at_price == blank
                or variant.compare_at_price == 0
                or variant.compare_at_price < variant.price
              %}
                {% assign saw_variant_compare_at_price = variant.price %}
              {% else %}
                {% assign saw_variant_compare_at_price = variant.compare_at_price %}
              {% endif %}

              {% assign cpe = shop.metafields.sawholesale.cpe | default: 'true' %}
              {% if variant.metafields.sawholesale[price_key] != blank and cpe == 'true' %}
                {% assign saw_variant_price = variant.metafields.sawholesale[price_key] %}
              {% else %}
                {% assign saw_variant_price = saw_variant_compare_at_price
                  | times: saw_discount
                %}
              {% endif %}

              {% if saw_discount == 1 and variant.metafields.sawholesale[price_key] == blank %}
                <!-- original prices here -->
                {{ variant.price | money }}
              {% else %}
                {{ saw_variant_price | money }}
                {% comment %}
                  <del>{{ saw_variant_compare_at_price | money }}</del>
                {% endcomment %}
              {% endif %}
            </td>

            <td style="text-align: center;">
              {% assign disabled = '' %}
              {% assign max = '' %}
              {% unless variant.inventory_management == blank
                or variant.inventory_policy == 'continue'
              %}
                {% assign max = variant.inventory_quantity %}
                {% for item in cart.items %}
                  {% if item.id == variant.id %}
                    {% assign max = max | minus: item.quantity %}
                  {% endif %}
                {% endfor %}
              {% endunless %}
              {%- unless variant.inventory_management == blank
                or variant.inventory_policy == 'continue'
              -%}
                {% if max < 1 %}{% assign disabled = 'disabled' %}{% endif %}
              {%- endunless -%}
              <quantity-input class="quantity {{ disabled }}">
                <button class="quantity__button no-js-hidden" name="minus" type="button">
                  <span class="visually-hidden">
                    {{-
                      'products.product.quantity.decrease'
                      | t: product: product.title
                      | escape
                    -}}
                  </span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    focusable="false"
                    role="presentation"
                    class="icon icon-minus"
                    fill="none"
                    viewBox="0 0 10 2"
                  >
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M.5 1C.5.7.7.5 1 .5h8a.5.5 0 110 1H1A.5.5 0 01.5 1z"
                          fill="currentColor"></path>
                  </svg>
                </button>

                <input
                  class="quantity__input"
                  type="number"
                  value="0"
                  min="0"
                  aria-label="{{ 'products.product.quantity.input_label' | t: product: product.title | escape }}"
                  data-id="{{ variant.id }}"
                  onfocus="this.select()"
                  {% if max %}
                    max="{{ max }}"
                  {% endif %}
                  {{ disabled }}
                >
                <button class="quantity__button no-js-hidden" name="plus" type="button">
                  <span class="visually-hidden">
                    {{-
                      'products.product.quantity.increase'
                      | t: product: product.title
                      | escape
                    -}}
                  </span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    focusable="false"
                    role="presentation"
                    class="icon icon-plus"
                    fill="none"
                    viewBox="0 0 10 10"
                  >
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M1 4.51a.5.5 0 000 1h3.5l.01 3.5a.5.5 0 001-.01V5.5l3.5-.01a.5.5 0 00-.01-1H5.5L5.49.99a.5.5 0 00-1 .01v3.5l-3.5.01H1z"
                          fill="currentColor"></path>
                  </svg>
                </button>
              </quantity-input>
            </td>
          </tr>
        {% endif %}
      {% endunless %}
    {% endunless %}
  {% endfor %}
{% endcomment %}
